# 環境構築

## 1.2 モータードライバの電装

データシートを見ながらモータドライバの電装を行う→ [モータードライバのデータシート MAN-G-SOLTWIIG%20Ver5002.pdf](/reference_data/MAN-G-SOLTWIIG%20Ver5002.pdf)

完成例

![](/docs/img/maestro.jpg)

###  モータユニットとの接続(モータ)
- 緑のでかいターミナル端子を使う。
- 6端子の内２つが24V電源供給、のこりの4つがモータへの配線（M1, M2, M3, PE(アース接続)）となる
- ![](/docs/img/connectio-motor.png)

###  モータユニットとの接続(エンコーダ)
- インクリメンタルかアブソリュートかで配線が異なる
- 上記PDFの45ページ参照
- インクリメンタル： `PortA_ENC_A+`, `PortA_ENC_A-`, `PortA_ENC_B+`, `PortA_ENC_B-`を使用する（1,3, 5, 7ピン）
  - モータ側のエンコーダ配線の色は[ココらへんのデータシート](/reference_data/LAC16D04-3　MDH(12)-40XX-XXXE.pdf)を見て確認すると良き. このデータシートの場合は紫、紫黒、緑、緑黒
- アブソリュート：`ABS_CLK+`, `ABS_CLK-`, `ABS_DATA+`, `ABS_DATA-`を使用する（1, 3, 5, 7ピン）
- これとは別でエンコーダの電源も供給する必要がある。`+5V`, `COMRFT (GNDのこと？)`を使用
- アブソリュートエンコーダの時の接続(上記PDFの48ページ)
  - ![](/docs/img/abs-enc-connection.png)

### Maestroとの通信
- MestroとはEtherCatで接続される。全てのモータードライバとMaestroは同じEtherCatネットワークに接続される必要がある
- 既存のEthernet用ケーブルが研究室にあるので、それを使用する
- そして、そのネットワーク上のケーブルの一端がMaestroの`EtherCAT1`のLANポートに接続する


### 1.3 電源周りの電装

制御PCの電源以外に、以下の三種類の電源を用意する

- Maestro用：12V電源→Mestroの側面にある緑色のDC端子
- モータードライバのロジック電源：12V
- モータ動作用：24V電源→各モータドライバに供給する。緊急停止ボタンを経由してターミナルブロックを使用し各モータードライバにつながっている


## MaestroのIPの設定

> [!IMPORTANT]
> 重要！（Elmoのプログラムを動かす際にも必要）

Elmoは基本的にを固定IPで使用するため、その際にIPアドレスの設定が必要となる。

一番の参考資料：[/reference_data/G-MAS Administrative and Motion API.pdf](/reference_data/)の`4.2. G-MAS PC configuration`の章<s>（接続例がWindows XPなので察し、、、）</s>

1. ElmoとWindows PCをUSB接続する
2. TeraTerm上でUSB接続したMaestroが見えることを確認（COMポートが新しく追加される。`ELMO GMAS`があればOK）
   1. 認識されないPCもあるみたい
3. Tera Termの新規接続で`ELMO GMAS`を選択し、接続する
4. IPを設定(以下を入力)
   1. `ipaddr 192.168.aaa.bbb` (aaa.bbbを適当に決める)
      1. `ipaddr`だけ入力すると現在の設定値を確認できる
   2. ![](/docs/img/maestro-ip-config.png)
   3. Maestroで制御するモータードライバは，指定したIPに対して連番になる．よって，十分に指定ipの後ろに空きがあるものにする
5. IPマスクの設定
   1. `ipmask 255.255.0.0` (ルーター側でも設定している際は同じ値にする)
6. デフォルトゲートウェイの設定
   1. `defgateway 10.10.10.2`
7. DHCPの設定
   1. 
8. `reboot`する（しないと認識されない！！）
9.  再度接続して結果を確認
   1. `ipmask`や`ipaddr`を入力し、設定した値になっていれば成功
10. pingしてみる
   1.  ほかのPCのターミナルから`ping <ElmoのIPアドレス>`を実行してpingが返ってくることを確認。この時点で応答がなかったら設定がおかしい
  
これでも繋がらない時は、

- ローカルのネットワークを構築する
  - インターネットにつながっていたり他の端末があると接続がキレる現象が何回か起きた
  - MaestroとElmoとPCだけのネットワークを組むと良さそう
- ルーターのゲートウェイ設定をいじる
  - デフォルトゲートウェイのIPアドレスがMaestroの`defgateway`で指定したものと合っているか？
  - ルーターによっては接続ログが見れるものもあるのでそれで追ってみると良さそう
- 参考
  - 1: https://www.elmomc.com/capabilities/motion-control/host-communication/getting-started-with-g-mas-connections/
  - 2: https://www.elmomc.com/members/NetHelp1/Elmo.htm#!gmasinitialconnectio.htm
- 上記をMaestroのプログラム上からもできるらしい
  - `MMC_SetIpAddrCmd`関数や`MMC_SetDhcpCmd`関数
  - [/reference_data/Maestro Administrative and Motion API.pdf](/reference_data/MaestroAdministrativeandMotionAPI.pdf) を参照すると使い方がが書かれている


## Maestroに接続する（Elmo Application Studio使用）

モータードライバをチューニングするために、`Elmo Application Studio`というソフトウェアを使用する([ダウンロード先](https://www.elmomc.com/product/easii/))。その際にIPアドレスの設定などが必要なのでメモしておく

     

## モータドライバのチューニング

モータドライバのチューニングは`Elmo Appliaction Studio`を用いて行う. 

パラメータ同定結果をモータドライバが保存してくれるため、プログラム側から調整せずとも綺麗に動かすことができるので便利。目標位置に動かす(指令：movePosition())だけや指令速度で動かす（指令：moveVelocity()）だけならすぐ使える

`Quick Tuning`と`Expert Tuning`の二種類があり、Export Tuningの方が設定できる項目が多い。Quick Tuningを行いエラーや警告がでたら`export tuning`で微調整するというのをやっていた


1. 環境構築（次回起動以降は必要ない）
   - `Elmo Application Studio`を起動したPC --(ローカルIPでLAN接続)--> Maestro --(EtherCAT)--> パラメタ同定したいモタドラ + モータ　という環境を作る
   - EASの左の階層構造で「♪P01」とかのドライバあったら右クリックして「Remove」で削除しておく
      - 接続すると自動でMDが認識されるので 
   - 左のタブの`Workspace 〇〇`を右クリック→ `Add Platinum Maestro EtherCAT`
     - P01が作成される
   - メイン画面の`Maestro Connection`で
      - `Connection Type`を`Maestro TCP/IP`に、 
      - `IP Address`をMaestroのIPアドレスに設定する（下の画像参照）
      - `Host IP Address`をPCのアドレスに設定（自動で入力されることもある）
   - ![](/docs/img/elmo-config-1.png)
   - EASの上のタブで「System Configuration」を選択し、「Connect」で接続する
     - 自動的にモータドライバが認識され、`♪P01`の中に`P01.a01(twitter)`や`P02.a02(twitter)`などが作成される。これがここのMDに対応する
     - この時、昔のパラメータが残っていると`Upload configutration from maestro ...`のようなダイアログが出てくるのでOKする。
2. プレオペモードに変更（`System Configuration`たぶの`Pre Op Mode`）
   - プレオペモード：　EASでチューニングしたり、EASの`Drive Setup and Motion`(画面左下)からUIでモータを動かすとき
   - オペレーションモード：Maestro内部に書き込んだプログラムから動かす時
4. チューニング
   - どれか１つのMD`P01.a0〇〇(twitter)`を選択
   - 右クリック→ConnectでMDに接続する
   - 画面右下で`Drive Setup and Motion`で以下のように設定。
     - ![](/docs/img/elmo-config-2.png)
     - ![](/docs/img/elmo-config-3.png)
     - インクリメンタルエンコーダの場合：エンコーダの種類を`Encoder Quat PortA`にする（表の上の青文字のところを変更）
        - ![](/docs/img/elmo-config-inc.png)
   - Continuous Stall Current [A]は，定格電流でok　（2Aに設定した）
   - Peak Currentは定格電流の1.5倍~2.0倍程度 (5Aに設定した).  間違っても突入電流にしない．モータが壊れる
   - Pole of pairs per revolution : <s>16</s> -> 2
       - 最初は16に設定し、その後パラメータ同定中にElmoから1 or 2だったよって言われたので2に変更（IdentifiedとPredefinedを選択する画面でIdentifiedを選択）
       - Elmo Applicatoin StudioのPDFにある、4.1.2.2章を参照（138ページらへん）
   - アブソリュートエンコーダの場合、以下のように設定する
     - MotorSettingsのFeedback Settingsで
     - Serial Absolute - SSI Port A
       - [モータLAC17E03のデータシート](/reference_data/LAC17E03-3%E3%80%80MDX-40XX-20B.pdf)の一ページ目にはBiSS-Cフォーマットと書かれているが、BiSSS-Cで動かすとスケールがおかしかった。
       - `SSI Port A`に設定すること
     - HW Sensor Resolution : 20bit
     - SW Sensor Resolution : 20bit
     - Clock : 2.5MHz
     - Protocol Total bit : <s>28bit</s> 26bit?
     - ![](/docs/img/elmo-config-5.png)
     - ここらへんの値はデータシートを参考にすること 
       - ![](/docs/img/encoder-datasheet-1.png) 
   - すべての設定が完了する（✅マークがつく）と、右下のApplyボタンが押せるようになる。Apply押すとモータードライバーに書き込める
5. （Optional）目標電流を取得できるようにする
   - デフォルトでは目標トルクがモータードライバとのEtherCAT通信内容に入っていないため、以下のように設定する
   - EASでP01を右クリック → `Edit EtherCAT configuration` -> モータードライバ(`a01(twitter)`など)を選択
   - FMMU/SM -> SM2(output)から[0X160C Target Torque]を追加する
6. モーターを接続（動作テスト）
   - 左下の画面の`Maestro Setup and Motion`を選択
   - ああ // TODO: 
7. オペレーションモードにしてDisconnect
   - プレオペモードのままだと、MaestroのC++プログラムからモータに接続できない。オペレーションモードに戻すこと

# プログラム、ソフトウェアの構築

MaestroとPCそれぞれでビルド環境などを整える必要がある。MestroとPCともにC++とCMake（ビルドツール）を使って開発している


##  Masstro用の環境構築

### A. Maestro Developper Studioを使う場合
Mestro側のプログラミング開発は***本来***`MDS(Maestro Developper Studio)）というソフトウェアを使って行う。（[公式サイト](https://www.elmomc.com/capabilities/motion-control/host-programming-environment/g-mas-developer-studio-gds/) ）

[使い方のPDF](/reference_data/MDS_UM3.pdf)を参考にしながら開発する（ OR ネットに転がっていた古いバージョンのドキュメント→[ここ](https://www.pk-rus.ru/fileadmin/download/gds_um3.pdf)

- MDSを起動
- // TODO：

</details>

### B. CUIベースで開発する場合

> [!NOTE]
> 
> CUIベース（ターミナルベース）で開発することになった経緯
> 
> 一般的には上記のMDSで開発するが、MDSはWindows版しか提供されておらず、PC側をUbuntuで開発していてわざわざOSを分けるのが面倒だったため、MaestroのプログラムもUbuntu上で開発するようにした。

MestroはARMのプロセッサを使っているため、専用のコンパイラをダウンロードして使用する

- [このサイト](https://releases.linaro.org/components/toolchain/binaries/latest-5/arm-linux-gnueabihf/)からコンパイラをダウンロードする
  - `gcc-linaro-5.5.0-2017.10-x86_64_arm-linux-gnueabihf`
- ダウンロードしたコンパイラにたいして環境変数`PATH`を通す
  - // TODO
- Maestroが提供しているAPIのライブラリファイルを抽出する
  - MDSは[Eclipse](https://ja.wikipedia.org/wiki/Eclipse_(%E7%B5%B1%E5%90%88%E9%96%8B%E7%99%BA%E7%92%B0%E5%A2%83))というIDE（総合開発環境ソフト）をもとに作られていて、実行ファイルの中身を見るとMaestroのAPIやライブラリ部分を抽出できる
  - 抽出後のもの( https://github.com/20niship/GMAS-elmo-lib/tree/master )があるのでこのレポジトリではこちらを使用。CMakeを使ってライブラリをリンクしている


## 2. PC

### 2.1 必要なビルドツールのインストール

- Ubuntu : 
  - `sudo apt install cmake git make build-essential -y`
  - `sudo apt install libmodbus libpcl libtinyxml2-dev -y`
  - Clangまたはg++のコンパイラをインストールする `sudo apt install g++11 gcc11`などで入れる
- Mac :
  - `brew install libmodbus git make tinyxml2`
- Win:
  - 動作確認していないので不明

### 2.2 modbusのインストール

Maestroと通信するために、[libmodbus](https://github.com/stephane/libmodbus)というライブラリをインストールする必要がある

参照：http://linux-memory.blogspot.com/2012/12/libmodbus.html
 
- Ubuntu : `sudo apt install libmodbus-dev` 
- Mac : `brew install libmodbus`
- その他↓（動作確認してない）

```sh
git clone https://github.com/stephane/libmodbus.git
cd libmodbus
./configure
make
make install
```


